<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress MQTT library: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="cypress_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress MQTT library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Cypress MQTT library provides an easy-to-use APIs for Cypress devices to connect with cloud MQTT brokers and perform MQTT publish and subscribe operations.</p>
<h1><a class="anchor" id="section1"></a>
Library Components</h1>
<p>This MQTT library consists of two components:<br />
 1) MQTT wrapper layer.<br />
 2) AWS IoT Device SDK C library.</p>
<p>AWS IoT Device SDK library is an open source library and it uses the <a href="https://devops-git.aus.cypress.com/repo/aws-iot-device-sdk-port">aws-iot-device-sdk-port</a> library functions to perform MQTT network related operations. The application that uses this library should invoke the MQTT wrapper layer API functions and which internally calls AWS IoT Device SDK library and aws-iot-device-sdk-port library API functions to perform MQTT publish/subscribe operations.</p>
<p><a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/202011.00">AWS-IoT Device SDK C Library Link</a></p>
<h2><a class="anchor" id="section1_1"></a>
MQTT wrapper layer</h2>
<p>This wrapper layer provides the APIs to users that are required to perform MQTT publish and subscribe operations on the Cypress platform. This layer contains APIs that are used for creating MQTT instances, Establishing Secure or non secure MQTT client session with MQTT broker to send and receive MQTT messages. This layer also handles retry logic for failed publish messages.</p>
<h2><a class="anchor" id="section1_2"></a>
AWS IoT Device SDK C - Tag: 202011.00</h2>
<p>This is an open source MQTT library developed and maintained by Amazon. This library implements the core MQTT protocol logic.</p>
<ul>
<li>"AWS IoT Device SDK C" library provides following features:<ul>
<li>MQTT 3.1.1 client</li>
<li>Synchronous API for MQTT operations.</li>
<li>Multithreaded API by default.</li>
<li>Complete separation of MQTT and network stack, allowing MQTT to run on top of any network stack.</li>
<li>MQTT persistent session support.</li>
<li>Supports Quality of Service (QoS) levels 0, 1 and 2.</li>
<li>Supports MQTT connection over both secured and non secured TCP connections.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="section_platforms"></a>
Supported Platforms</h1>
<p>This library and its features are supported on following Cypress platforms:</p><ul>
<li><a href="https://www.cypress.com/documentation/development-kitsboards/psoc-6-wi-fi-bt-prototyping-kit-cy8cproto-062-4343w">PSoC6 WiFi-BT Prototyping Kit (CY8CPROTO-062-4343W)</a></li>
<li><a href="https://www.cypress.com/documentation/development-kitsboards/psoc-62s2-wi-fi-bt-pioneer-kit-cy8ckit-062s2-43012">PSoC 62S2 Wi-Fi BT Pioneer Kit (CY8CKIT-062S2-43012)</a></li>
<li><a href="https://www.cypress.com/documentation/development-kitsboards/psoc-6-wifi-bt-pioneer-kit-cy8ckit-062-wifi-bt">PSoC 6 WiFi-BT Pioneer Kit (CY8CKIT-062-WiFi-BT)</a></li>
</ul>
<h1><a class="anchor" id="section_dependencies"></a>
Dependent libraries</h1>
<p>This MQTT client library depends on the following libraries. Both these libraries are included by default.</p><ul>
<li><a href="https://github.com/cypresssemiconductorco/wifi-mw-core">Wi-Fi Middleware Core</a></li>
<li><a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/202011.00">AWS-IoT Device SDK Library</a></li>
</ul>
<h1><a class="anchor" id="section_quick_start"></a>
Quick start</h1>
<ul>
<li>A "reasonable amount of time" to wait for keepalive responses from the MQTT broker is configured using <code>MQTT_PINGRESP_TIMEOUT_MS</code> in *./include/core_mqtt_config.h*. This value may be adjusted to suit the use case and network environment.</li>
<li>The reference *./include/core_mqtt_config.h* file that is bundled with this library provides the configurations required for the <a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/202011.00">AWS IoT Device SDK</a> library. The application must copy this file to the root directory where the application Makefile is present, and suitably adjust the default settings.</li>
<li>This MQTT Client library does not support secure connections to the public <code>test.mosquitto.org</code> broker by default. because the server uses the SHA1 hashing algorithm. As cautioned by Mbed TLS, SHA-1 is considered a weak message digest and is therefore not enabled in Mbed TLS by default. The use of SHA-1 for certificate signing constitutes a security risk. It is recommended to avoid dependencies on it, and consider stronger message digests instead.</li>
<li>A set of pre-defined configuration files have been bundled with wifi-mw-core library for FreeRTOS, LwIP, and Mbed TLS. You should review the configuration and make the required adjustments. See the "Quick Start" section in <a href="https://github.com/cypresssemiconductorco/wifi-mw-core/blob/master/README.md">README.md</a> for more details.</li>
<li>Define following COMPONENTS in the application's makefile for the MQTT Library. For additional information, see the "Quick Start" section in <a href="https://github.com/cypresssemiconductorco/wifi-mw-core/blob/master/README.md">README.md</a> <div class="fragment"><div class="line">COMPONENTS=FREERTOS MBEDTLS LWIP SECURE_SOCKETS</div></div><!-- fragment --></li>
<li>MQTT Library disables all the debug log messages by default. To enable log messages, the application must perform the following:<ol type="1">
<li>Add <code>ENABLE_MQTT_LOGS</code> macro to the <em>DEFINES</em> in the code example's Makefile. The Makefile entry would look like as follows: <div class="fragment"><div class="line">DEFINES+=ENABLE_MQTT_LOGS</div></div><!-- fragment --></li>
<li>Call the <code>cy_log_init()</code> function provided by the <em>cy-log</em> module. cy-log is part of the <em>connectivity-utilities</em> library. See <a href="https://cypresssemiconductorco.github.io/connectivity-utilities/api_reference_manual/html/group__logging__utils.html">connectivity-utilities library API documentation</a> for cy-log details.</li>
</ol>
</li>
</ul>
<h1><a class="anchor" id="Additional_info"></a>
Addtional Information</h1>
<ul>
<li><a href="http://git-ore.aus.cypress.com/repo/mqtt/-/blob/master/RELEASE.md">MQTT Client Library RELEASE.md</a> .</li>
<li><a href="https://www.cypress.com/products/modustoolbox-software-environment">ModusToolbox Software Environment, Quick Start Guide, Documentation, and Videos</a> .</li>
<li><a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/202011.00">AWS-IoT Device SDK Library</a> .</li>
<li><a href="https://github.com/cypresssemiconductorco?q=mtb-example-anycloud%20NOT%20Deprecated">ModusToolbox AnyCloud code examples</a> .</li>
</ul>
<h1><a class="anchor" id="mqtt_api_call_sequence"></a>
API Call Sequence</h1>
<p>This section provides the details of the API call sequence for performing various MQTT operations. This call sequence uses APIs defined by MQTT library.</p>
<h2><a class="anchor" id="section2_1"></a>
For Init, Create, Connect, Publish and Subscribe</h2>
<p>The API call sequence given below should be used to connect to a MQTT broker and to perform MQTT subscribe and publish operations:</p>
<pre class="fragment">                    +-----------------------+
                    |     cy_mqtt_init()    |
                    +-----------------------+
                                |
                                v
                    +-----------------------+
                    |    cy_mqtt_create()   |
                    +-----------------------+
                                |
                                v
                    +-----------------------+
                    |   cy_mqtt_connect()   |
                    +-----------------------+
                                |
                                v
                    +-----------------------+
                    |  cy_mqtt_subscribe()  |
                    +-----------------------+
                                |
                                v
                    +-----------------------+
                    |   cy_mqtt_publish()   |
                    +-----------------------+
</pre><h2><a class="anchor" id="section2_2"></a>
For UnSubscribe, Disconnect, Delete and DeInit.</h2>
<p>The API call sequence given below should be used to perform MQTT unsubscribe and disconnect operations with the MQTT broker: </p><pre class="fragment">                   +-----------------------+
                   | cy_mqtt_unsubscribe() |
                   +-----------------------+
                               |
                               v
                   +-----------------------+
                   |  cy_mqtt_disconnect() |
                   +-----------------------+
                               |
                               v
                   +-----------------------+
                   |    cy_mqtt_delete()   |
                   +-----------------------+
                               |
                               v
                   +-----------------------+
                   |    cy_mqtt_deinit()   |
                   +-----------------------+
</pre><h2><a class="anchor" id="section2_3"></a>
Note :</h2>
<ul>
<li>Functions <a class="el" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a> and <a class="el" href="group__mqtt__api__functions.html#ga7193aa962b03640955740db074fb36fb">cy_mqtt_deinit</a> are not thread-safe.</li>
<li>Application should allocate network buffer and same buffer has to be passed while creating the MQTT object. MQTT library use this buffer for sending and receiving MQTT packets. <a class="el" href="group__mqtt__defines.html#ga18d0c836b0120b44ea0066d20a741d81">CY_MQTT_MIN_NETWORK_BUFFER_SIZE</a> is the minimun size of network buffer required for library to handle MQTT packets.</li>
<li>Application should call <a class="el" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a> before calling any other MQTT library function, and should not call other MQTT library functions after calling <a class="el" href="group__mqtt__api__functions.html#ga7193aa962b03640955740db074fb36fb">cy_mqtt_deinit</a>.</li>
<li>MQTT instance is created using <a class="el" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a> function. MQTT library allocates resource for each created instance, hence application should delete the MQTT instance by calling <a class="el" href="group__mqtt__api__functions.html#gacdd40da0ad0e6bfb55fbf14c2aca0577">cy_mqtt_delete</a> after performing the desired MQTT operations.</li>
<li>After calling <a class="el" href="group__mqtt__api__functions.html#gacdd40da0ad0e6bfb55fbf14c2aca0577">cy_mqtt_delete</a> API function, all the resource associated with MQTT handle are freed. So user should not use same MQTT handle after delete.</li>
<li>MQTT disconnection event notification is not sent to application when disconnection is initiated from application.</li>
<li>When application receives MQTT disconnection event notification due to physical network disconnection or not receiving the PING response on time, application should call <a class="el" href="group__mqtt__api__functions.html#gab7be772e82d3f8a80e1cbb1da156be17">cy_mqtt_disconnect</a> function to release the resource allocated during <a class="el" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b">cy_mqtt_connect</a>.</li>
</ul>
<h1><a class="anchor" id="section_code_snippet"></a>
Code Snippets</h1>
<h2><a class="anchor" id="snip1"></a>
Code Snippet 1: Initialize MQTT network socket</h2>
<p>This code snippet demonstrates the initialization of the network sockets required for the MQTT library. </p><div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_init( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t TestRes = CY_RSLT_SUCCESS;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip2"></a>
Code Snippet 2: Creating MQTT instance for Secure connection with MQTT broker</h2>
<p>This code snippet demonstrates the initialization of the configuration structures required for creating an MQTT client handle for establishing secured connection with MQTT broker, and the usage of the <a class="el" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9" title="Creates a MQTT instance and initializes its members based on the supplied arguments. ">cy_mqtt_create()</a> API function. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_cert[] = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_key[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> root_ca_cert[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line"></div><div class="line">cy_mqtt_t         secure_mqtthandle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_secure_event_cb( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_create_secure( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_cert;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( client_cert );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_key;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( client_key );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;root_ca_cert;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( root_ca_cert );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_secure_event_cb, NULL,</div><div class="line">                              &amp;secure_mqtthandle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip3"></a>
Code Snippet 3: Creating MQTT instance for Non secure connection with MQTT broker</h2>
<p>This code snippet demonstrates the initialization of the configuration structures required for creating an MQTT client handle for establishing non secured connection with MQTT broker, and the usage of the <a class="el" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9" title="Creates a MQTT instance and initializes its members based on the supplied arguments. ">cy_mqtt_create()</a> API function. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_NON_SECURED               ( 1883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line">cy_mqtt_t         nonsecure_mqtthandle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_non_secure_event_cb( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_create_non_secure( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_NON_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              NULL, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_non_secure_event_cb, NULL,</div><div class="line">                              &amp;nonsecure_mqtthandle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip4"></a>
Code Snippet 4: Establishing MQTT client session</h2>
<p>This code snippet demonstrates the steps to establish MQTT client session with MQTT broker using the previously created MQTT handle, and the usage of the <a class="el" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b" title="Connects to the given MQTT broker using a secured/non-secured TCP connection and establishes MQTT cli...">cy_mqtt_connect()</a> API function. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;CypressTest&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> clientcert[] = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> clientkey[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> rootcacertificate[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line"></div><div class="line">cy_mqtt_t         mqtthandle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_event_cb( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_connect( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a>        will_msg;</div><div class="line">    <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a>        connect_info;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;will_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> ) );</div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;connect_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the will information. */</span></div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ac3dd00abb3e55019b0f41f169f047d65">qos</a> = MQTT_QOS2;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> = MQTT_TOPIC;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> = MQTT_WILL_MESSAGE;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a> = MQTT_WILL_MESSAGE_LENGTH;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;clientcert;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( clientcert );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;clientkey;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( clientkey );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;rootcacertificate;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( rootcacertificate );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a3df6c6eb014ef6e7566616ece9fa5b1b">client_id</a> = MQTT_CLIENT_IDENTIFIER;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#ad6ff55a3dfeb52324950c2447d9c8c4e">client_id_len</a> = MQTT_CLIENT_IDENTIFIER_LENGTH;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a40ded02bb2c432ed7080c1589ebef8e5">keep_alive_sec</a> = MQTT_KEEP_ALIVE_INTERVAL_SECONDS;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a0238ef1799952c8eeaf4c61c9187c3a6">will_info</a> = &amp;will_msg;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_event_cb, NULL,</div><div class="line">                              &amp;mqtthandle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b">cy_mqtt_connect</a>( mqtthandle, &amp;connect_info );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip5"></a>
Code Snippet 5: MQTT subscribe and unsubscribe</h2>
<p>This code snippet demonstrates the steps to subscribe for particular topic, unsubscribe from previously subscribed MQTT topic, and the usage of the <a class="el" href="group__mqtt__api__functions.html#gac9e1748d2425be6923069fa6f7125fb5" title="Subscribes for MQTT message on given MQTT topic. ">cy_mqtt_subscribe()</a> and <a class="el" href="group__mqtt__api__functions.html#ga5bf4f13c41463bd239f2940a02401121" title="Unsubscribes from a given MQTT topic. ">cy_mqtt_unsubscribe()</a> API functions. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;CypressTest&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_NUM_OF_SUBS_IN_SINGLE_REQ      ( 1U )</span></div><div class="line"><span class="preprocessor">#define MQTT_NUM_OF_UNSUBS_IN_SINGLE_REQ    MQTT_NUM_OF_SUBS_IN_SINGLE_REQ</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_certificate[]  = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_private_key[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> root_ca_certificate[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line">cy_mqtt_t         mqtt_handle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_eventcb( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_subscribe_unsubscribe( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a>        will_msg;</div><div class="line">    <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a>        connect_info;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    <a class="code" href="structcy__mqtt__subscribe__info__t.html">cy_mqtt_subscribe_info_t</a>      sub_msg[1];</div><div class="line">    <a class="code" href="structcy__mqtt__subscribe__info__t.html">cy_mqtt_unsubscribe_info_t</a>    unsub_msg[1];</div><div class="line"></div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;will_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> ) );</div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;connect_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line">    memset( &amp;sub_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__subscribe__info__t.html">cy_mqtt_subscribe_info_t</a> ) );</div><div class="line">    memset( &amp;unsub_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__subscribe__info__t.html">cy_mqtt_unsubscribe_info_t</a> ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the will information. */</span></div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ac3dd00abb3e55019b0f41f169f047d65">qos</a> = MQTT_QOS2;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> = MQTT_TOPIC;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> = MQTT_WILL_MESSAGE;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a> = MQTT_WILL_MESSAGE_LENGTH;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_certificate;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( client_certificate );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_private_key;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( client_private_key );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;root_ca_certificate;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( root_ca_certificate );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a3df6c6eb014ef6e7566616ece9fa5b1b">client_id</a> = MQTT_CLIENT_IDENTIFIER;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#ad6ff55a3dfeb52324950c2447d9c8c4e">client_id_len</a> = MQTT_CLIENT_IDENTIFIER_LENGTH;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a40ded02bb2c432ed7080c1589ebef8e5">keep_alive_sec</a> = MQTT_KEEP_ALIVE_INTERVAL_SECONDS;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a0238ef1799952c8eeaf4c61c9187c3a6">will_info</a> = &amp;will_msg;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_eventcb, NULL,</div><div class="line">                              &amp;mqtt_handle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b">cy_mqtt_connect</a>( mqtt_handle, &amp;connect_info );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Subscribe request. */</span></div><div class="line">    sub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#aa4b608145f6dca9d3740d43d83a5f960">qos</a> = MQTT_QOS2;</div><div class="line">    sub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#a7233b6d440d794a302673089552f7acb">topic</a> = MQTT_TOPIC;</div><div class="line">    sub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#a2bd950023cbd33864c6bc6343af7b06b">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#gac9e1748d2425be6923069fa6f7125fb5">cy_mqtt_subscribe</a>( mqtt_handle, &amp;sub_msg[0], MQTT_NUM_OF_SUBS_IN_SINGLE_REQ );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*wait for some time for subscribed topic messages. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Unsubscribe request. */</span></div><div class="line">    unsub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#aa4b608145f6dca9d3740d43d83a5f960">qos</a> = MQTT_QOS2;</div><div class="line">    unsub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#a7233b6d440d794a302673089552f7acb">topic</a> = MQTT_TOPIC;</div><div class="line">    unsub_msg[0].<a class="code" href="structcy__mqtt__subscribe__info__t.html#a2bd950023cbd33864c6bc6343af7b06b">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5bf4f13c41463bd239f2940a02401121">cy_mqtt_unsubscribe</a>( mqtt_handle, &amp;unsub_msg[0], MQTT_NUM_OF_UNSUBS_IN_SINGLE_REQ );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip6"></a>
Code Snippet 6: MQTT publish</h2>
<p>This code snippet demonstrates the steps to publish messages on MQTT topic, and the usage of the <a class="el" href="group__mqtt__api__functions.html#ga2b565253902a622a2c275c61ef1fd84f" title="Publishes the MQTT message on given MQTT topic. ">cy_mqtt_publish()</a> API function. User can choose appropriate QoS level for the application. In this snippet QoS level is set as 2. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;CypressTest&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_PUB_MESSAGE                    &quot;Publish - Hello MQTT!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_PUB_MESSAGE_LENGTH             ( ( uint16_t ) ( sizeof( MQTT_PUB_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> clientcertificate[]  = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> clientprivate_key[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> rootca_certificate[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line">cy_mqtt_t         MQTThandle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_event_call_back( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_publish( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a>        will_msg;</div><div class="line">    <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a>        connect_info;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a>        pub_msg;</div><div class="line"></div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;will_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> ) );</div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;connect_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line">    memset( &amp;pub_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the will information. */</span></div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ac3dd00abb3e55019b0f41f169f047d65">qos</a> = MQTT_QOS2;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> = MQTT_TOPIC;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> = MQTT_WILL_MESSAGE;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a> = MQTT_WILL_MESSAGE_LENGTH;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;clientcertificate;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( clientcertificate );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;clientprivate_key;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( clientprivate_key );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;rootca_certificate;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( rootca_certificate );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a3df6c6eb014ef6e7566616ece9fa5b1b">client_id</a> = MQTT_CLIENT_IDENTIFIER;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#ad6ff55a3dfeb52324950c2447d9c8c4e">client_id_len</a> = MQTT_CLIENT_IDENTIFIER_LENGTH;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a40ded02bb2c432ed7080c1589ebef8e5">keep_alive_sec</a> = MQTT_KEEP_ALIVE_INTERVAL_SECONDS;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a0238ef1799952c8eeaf4c61c9187c3a6">will_info</a> = &amp;will_msg;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_event_call_back, NULL,</div><div class="line">                              &amp;MQTThandle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b">cy_mqtt_connect</a>( MQTThandle, &amp;connect_info );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    pub_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ac3dd00abb3e55019b0f41f169f047d65">qos</a> = MQTT_QOS2;</div><div class="line">    pub_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> = MQTT_TOPIC;</div><div class="line">    pub_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line">    pub_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> = MQTT_PUB_MESSAGE;</div><div class="line">    pub_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a> = MQTT_PUB_MESSAGE_LENGTH;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga2b565253902a622a2c275c61ef1fd84f">cy_mqtt_publish</a>( MQTThandle, &amp;pub_msg );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip7"></a>
Code Snippet 7: MQTT disconnect</h2>
<p>This code snippet demonstrates the steps to end already established MQTT client session with MQTT broker, and the usage of the <a class="el" href="group__mqtt__api__functions.html#gab7be772e82d3f8a80e1cbb1da156be17" title="Initiates MQTT client disconnection from connected MQTT broker. ">cy_mqtt_disconnect()</a> API function. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;CypressTest&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_clientcertificate[]  = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_clientprivate_key[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_rootca_certificate[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line"></div><div class="line">cy_mqtt_t         MQTT_handle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_events_cb( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_disconnect( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a>        will_msg;</div><div class="line">    <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a>        connect_info;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;will_msg, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> ) );</div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;connect_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__connect__info__t.html">cy_mqtt_connect_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the will information. */</span></div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ac3dd00abb3e55019b0f41f169f047d65">qos</a> = MQTT_QOS2;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> = MQTT_TOPIC;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a> = MQTT_TOPIC_LENGTH;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> = MQTT_WILL_MESSAGE;</div><div class="line">    will_msg.<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a> = MQTT_WILL_MESSAGE_LENGTH;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_clientcertificate;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( MQTT_clientcertificate );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_clientprivate_key;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( MQTT_clientprivate_key );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_rootca_certificate;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( MQTT_rootca_certificate );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a3df6c6eb014ef6e7566616ece9fa5b1b">client_id</a> = MQTT_CLIENT_IDENTIFIER;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#ad6ff55a3dfeb52324950c2447d9c8c4e">client_id_len</a> = MQTT_CLIENT_IDENTIFIER_LENGTH;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a40ded02bb2c432ed7080c1589ebef8e5">keep_alive_sec</a> = MQTT_KEEP_ALIVE_INTERVAL_SECONDS;</div><div class="line">    connect_info.<a class="code" href="structcy__mqtt__connect__info__t.html#a0238ef1799952c8eeaf4c61c9187c3a6">will_info</a> = &amp;will_msg;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_events_cb, NULL,</div><div class="line">                              &amp;MQTT_handle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga2ffecf6ed7940d97c2c6fbc83783417b">cy_mqtt_connect</a>( MQTT_handle, &amp;connect_info );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Do MQTT publish and subscribe here. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Calling MQTT disconnect to end the MQTT client session with the broker. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#gab7be772e82d3f8a80e1cbb1da156be17">cy_mqtt_disconnect</a>( MQTT_handle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><h2><a class="anchor" id="snip8"></a>
Code Snippet 8: MQTT delete and deinit</h2>
<p>This code snippet demonstrates the de-allocation of the configuration structures and resources which are allocated during an MQTT client handle creation, and the usage of the <a class="el" href="group__mqtt__api__functions.html#gacdd40da0ad0e6bfb55fbf14c2aca0577" title="Deletes the given MQTT instance and frees the resources allocated for the instance by the cy_mqtt_cre...">cy_mqtt_delete()</a> and <a class="el" href="group__mqtt__api__functions.html#ga7193aa962b03640955740db074fb36fb" title="One-time deinitialization function for network sockets implementation. ">cy_mqtt_deinit()</a> API functions. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot; </span><span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;CypressTest&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div><div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_client_certificate[] = { <span class="comment">/* Client certificate here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_client_key[]  = { <span class="comment">/* Client key here.*/</span> };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> MQTT_root_ca_certificate[] = { <span class="comment">/* Root CA here.*/</span> };</div><div class="line"></div><div class="line">cy_mqtt_t         MQTT_obj_handle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_callback( cy_mqtt_t mqtt_handle, <a class="code" href="structcy__mqtt__event__t.html">cy_mqtt_event_t</a> event, <span class="keywordtype">void</span> *user_data )</div><div class="line">{</div><div class="line">    <a class="code" href="structcy__mqtt__publish__info__t.html">cy_mqtt_publish_info_t</a> *received_msg;</div><div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div><div class="line">    (void)user_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>( event.<a class="code" href="structcy__mqtt__event__t.html#a9823ea0788cb4e0bd82efd19d195b13e">type</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa0a7b7d2061d3a6331115e521c16fa0fb">CY_MQTT_EVENT_TYPE_DISCONNECT</a> :</div><div class="line">            <span class="keywordflow">if</span>( event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#abbc35b761acab1cda2d4f85418f9c32e">reason</a> == <a class="code" href="group__mqtt__struct.html#gga4e499e4898c3baae910860d7ce73f300a99e819db5a5b4c25e2eda4658e4a2ebb">CY_MQTT_DISCONN_TYPE_BROKER_DOWN</a> )</div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_TYPE_BROKER_DOWN .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                printf( <span class="stringliteral">&quot;\nCY_MQTT_DISCONN_REASON_NETWORK_DISCONNECTION .....\n&quot;</span> );</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__mqtt__struct.html#gga1cefedb516ade340c9a829ec7b998fbaa47cb2b095da4f477318ea1f37b58b330">CY_MQTT_EVENT_TYPE_PUBLISH_RECEIVE</a> :</div><div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#ad6c63ce8dd222f55eb6bb3825bee57af">topic_len</a>, received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#aacdf24feaf4d2ceb5c055e50d26ce432">topic</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.<a class="code" href="structcy__mqtt__event__t.html#abcd47d67886ef09e5c10681cdc90df99">data</a>.<a class="code" href="structcy__mqtt__event__t.html#a73dadd9c182b0786d9ed11fb7bb91c65">pub_msg</a>.<a class="code" href="structcy__mqtt__message__t.html#ae158e70e0ed56cfa2fe80a2e6407b1bc">packet_id</a> );</div><div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a3642a0462fa346cfcc8d114ba78a425e">payload_len</a>, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;<a class="code" href="structcy__mqtt__publish__info__t.html#a766647fe8a245f81ff5b2ed5ab57e556">payload</a> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_cy_mqtt_delete( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/* Status variables for various operations. */</span></div><div class="line">    <span class="comment">/* Status variables for various operations */</span></div><div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div><div class="line">    <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a>         broker_info;</div><div class="line">    cy_awsport_ssl_credentials_t  credentials;</div><div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div><div class="line">    uint8_t                       *buffer = NULL;</div><div class="line">    (void)TestRes;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga5386e4d0061fd77c3f68ba29553b3414">cy_mqtt_init</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div><div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div><div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( <a class="code" href="structcy__mqtt__broker__info__t.html">cy_mqtt_broker_info_t</a> ) );</div><div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div><div class="line"></div><div class="line">    <span class="comment">/* Set the credential information. */</span></div><div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_client_certificate;</div><div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( MQTT_client_certificate );</div><div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_client_key;</div><div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( MQTT_client_key );</div><div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;MQTT_root_ca_certificate;</div><div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( MQTT_root_ca_certificate );</div><div class="line"></div><div class="line">    security = &amp;credentials;</div><div class="line"></div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a1573327c42b9dd49610c55aa303e7fea">hostname</a> = MQTT_BROKER;</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#a38a8850406cc4f8e267e67837a23cd41">hostname_len</a> = strlen(MQTT_BROKER);</div><div class="line">    broker_info.<a class="code" href="structcy__mqtt__broker__info__t.html#ad90a2e276913e9598673e31d55ce808e">port</a> = MQTT_PORT_SECURED;</div><div class="line"></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga6637e2df9ebc12dfb98841fc38c88ce9">cy_mqtt_create</a>( buffer, NETWORK_BUFFER_SIZE,</div><div class="line">                              security, &amp;broker_info,</div><div class="line">                              (<a class="code" href="group__mqtt__api__functions.html#ga681347571799dfdde83ea39fdc1389a0">cy_mqtt_callback_t</a>)mqtt_callback, NULL,</div><div class="line">                              &amp;MQTT_obj_handle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Calling MQTT Delete to clean up the resources allocated during create. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#gacdd40da0ad0e6bfb55fbf14c2aca0577">cy_mqtt_delete</a>( mqtthandle );</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    mqtthandle = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/* De-initialize the MQTT network socket. */</span></div><div class="line">    TestRes = <a class="code" href="group__mqtt__api__functions.html#ga7193aa962b03640955740db074fb36fb">cy_mqtt_deinit</a>();</div><div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Failure path. */</span></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress MQTT library</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
</body>
</html>
